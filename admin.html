<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - All Polls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .edit-form { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
            <a href="/" class="text-blue-600 font-semibold hover:underline flex items-center space-x-1">
                <span>Create New Poll</span>
            </a>
        </div>
        
        <div id="polls-list" class="space-y-8">
            </div>
    </div>

    <script>
        const API_URL = '';

        async function fetchPolls() {
            try {
                const response = await fetch(`${API_URL}/admin/polls`);
                if (!response.ok) throw new Error('Could not fetch polls.');
                const polls = await response.json().then(data => data.reverse());
                
                const container = document.getElementById('polls-list');
                container.innerHTML = '';

                if (polls.length === 0) {
                    container.innerHTML = '<div class="bg-white text-center p-12 rounded-lg shadow-md">...</div>';
                    return;
                }

                polls.forEach(poll => {
                    const pollCard = document.createElement('div');
                    pollCard.className = 'bg-white p-6 rounded-xl shadow-lg transition';
                    pollCard.id = `poll-card-${poll.id}`;

                    const totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes, 0);
                    const shareLink = `${window.location.origin}/poll.html?id=${poll.id}`;

                    // --- View Mode HTML ---
                    const viewModeHtml = `
                        <div class="poll-view">
                            <div class="flex justify-between items-start">
                                <h2 class="text-2xl font-bold text-gray-900">${poll.question}</h2>
                                <span class="text-sm font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full">Total Votes: ${totalVotes}</span>
                            </div>
                            <ul class="mt-4 space-y-2 border-t pt-4">
                                ${poll.options.map(opt => `<li class="flex justify-between items-center text-gray-800 py-2"><span>${opt.text}</span><span class="font-semibold bg-gray-100 px-2 py-0.5 rounded">${opt.votes} votes</span></li>`).join('')}
                            </ul>
                            <div class="mt-4 pt-4 border-t flex justify-between items-center">
                                <input type="text" value="${shareLink}" class="w-full mr-2 px-3 py-2 bg-gray-50 border rounded-lg text-sm" readonly>
                                <button onclick="toggleEditView(${poll.id}, true)" class="bg-yellow-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-yellow-600">Edit</button>
                            </div>
                        </div>
                    `;
                    
                    // --- Edit Mode HTML ---
                    const editModeHtml = `
                        <div class="poll-edit" style="display: none;">
                            <h3 class="text-xl font-bold mb-4">Editing Poll</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-semibold">Question</label>
                                    <input type="text" name="question" value="${poll.question}" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg">
                                </div>
                                <div>
                                    <label class="text-sm font-semibold">Options</label>
                                    <div class="options-edit-container space-y-2 mt-1">
                                        ${poll.options.map(opt => `<input type="text" name="optionText" value="${opt.text}" class="w-full px-3 py-2 bg-gray-50 border rounded-lg">`).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex space-x-2">
                                <button onclick="saveChanges(${poll.id})" class="w-full bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600">Save Changes</button>
                                <button onclick="toggleEditView(${poll.id}, false)" class="w-full bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                            </div>
                        </div>
                    `;

                    pollCard.innerHTML = viewModeHtml + editModeHtml;
                    container.appendChild(pollCard);
                });
            } catch (error) {
                console.error('Error fetching polls:', error);
            }
        }

        function toggleEditView(pollId, isEditing) {
            const pollCard = document.getElementById(`poll-card-${pollId}`);
            const viewMode = pollCard.querySelector('.poll-view');
            const editMode = pollCard.querySelector('.poll-edit');
            
            if (isEditing) {
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
            } else {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
            }
        }

        async function saveChanges(pollId) {
            const pollCard = document.getElementById(`poll-card-${pollId}`);
            const newQuestion = pollCard.querySelector('input[name="question"]').value;
            const newOptionInputs = pollCard.querySelectorAll('input[name="optionText"]');
            const newOptions = Array.from(newOptionInputs).map(input => input.value);

            try {
                const response = await fetch(`${API_URL}/api/poll/${pollId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: newQuestion,
                        options: newOptions
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save changes.');
                }

                alert('Poll updated successfully!');
                fetchPolls(); // पोल लिस्ट को रिफ्रेश करें

            } catch (error) {
                alert(error.message);
            }
        }
        
        fetchPolls();
    </script>
</body>
</html>
